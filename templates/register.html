{% extends "base.html" %}
{% block title %}Register{% endblock %}

{% block nav %}
<a href="/login/" class="nav-pill" aria-label="Back to login">
  <!-- back icon -->
  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M14.5 6.5L9 12l5.5 5.5" stroke="white" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  Back to login
</a>
{% endblock %}

{% block content %}
<style>
  /* ===== move card higher (register only) ===== */
  .wrap{
    align-items:flex-start;
    padding-top:92px;
  }
  @media(max-width:480px){
    .wrap{ padding-top:78px; }
  }

  /* ===== top right button look (professional) ===== */
  .nav .nav-pill{
    display:flex;
    align-items:center;
    gap:8px;
    height:34px;
    padding:0 14px;
    border-radius:999px;
    text-decoration:none;
    color:#fff;
    font-weight:800;
    background: linear-gradient(90deg, rgba(15,122,58,.95), rgba(34,197,94,.95));
    box-shadow:0 8px 20px rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.18);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .nav .nav-pill svg{ width:18px; height:18px; }

  /* ===== REGISTER CARD (same style as before) ===== */
  .auth-card{
    width:min(560px, 92vw);
    margin-top:10px; /* little extra push down from navbar */
    padding:22px 22px 18px;
    border-radius:18px;
    background: rgba(255,255,255,.18);
    border: 1px solid rgba(255,255,255,.18);
    box-shadow: 0 18px 48px rgba(0,0,0,.45);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
  }

  /* ===== silver running title ===== */
  .auth-title{
    margin:0 0 6px;
    font-size:26px;
    font-weight:900;
    letter-spacing:.2px;

    background: linear-gradient(
      120deg,
      rgba(255,255,255,.70),
      rgba(255,255,255,.95),
      rgba(200,200,200,.85),
      rgba(255,255,255,.95),
      rgba(255,255,255,.70)
    );
    background-size: 220% 100%;
    -webkit-background-clip:text;
    background-clip:text;
    color:transparent;
    animation: silverRun 2.6s linear infinite;
  }
  @keyframes silverRun{
    0%{ background-position:0% 50%; }
    100%{ background-position:220% 50%; }
  }

  .auth-sub{
    margin:0 0 16px;
    font-size:13px;
    opacity:.92;
  }

  .field{ margin:12px 0; }
  .label{
    display:block;
    font-size:13px;
    font-weight:750;
    opacity:.95;
    margin-bottom:8px;
  }

  .input-wrap{ position:relative; }

  .input{
    width:100%;
    height:44px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.22);
    background: rgba(255,255,255,.92);
    color:#111;
    outline:none;
    padding:0 44px 0 44px;
    font-size:14px;
    box-sizing:border-box;
  }
  .input::placeholder{ color:#666; }

  .icon-left{
    position:absolute;
    left:14px;
    top:50%;
    transform:translateY(-50%);
    width:18px;
    height:18px;
    opacity:.95;
    pointer-events:none;
  }

  /* eye button (NO box) */
  .eye-btn{
    position:absolute;
    right:12px;
    top:50%;
    transform:translateY(-50%);
    width:32px;
    height:32px;
    border:0;
    padding:0;
    background:transparent;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
  }
  .eye-btn svg{ width:18px; height:18px; opacity:.95; }

  .btn-main{
    width:100%;
    height:46px;
    margin-top:14px;
    border:0;
    border-radius:999px;
    background: linear-gradient(90deg, #0f7a3a, #22c55e);
    color:#fff;
    font-weight:900;
    letter-spacing:.4px;
    cursor:pointer;
    box-shadow: 0 10px 26px rgba(0,0,0,.35);
  }
  .btn-main:active{ transform: translateY(1px); }

  .footer{
    margin-top:12px;
    text-align:center;
    font-size:13px;
    opacity:.95;
  }
  .footer a{
    color:#bfffd2;
    font-weight:900;
    text-decoration:none;
  }

  @media (max-width:480px){
    .auth-title{ font-size:24px; }
    .auth-card{ padding:20px 18px 16px; margin-top:6px; }
  }

  /* =========================
     ✅ ADDED: professional alerts
     ========================= */
  .err{
    margin: 10px 0 0;
    background: rgba(255, 0, 0, .14);
    border: 1px solid rgba(255, 0, 0, .25);
    color:#ffecec;
    padding: 10px 12px;
    border-radius: 12px;
    font-size: 13px;
  }
  .ok{
    margin: 10px 0 0;
    background: rgba(34, 197, 94, .14);
    border: 1px solid rgba(34, 197, 94, .25);
    color:#eafff1;
    padding: 10px 12px;
    border-radius: 12px;
    font-size: 13px;
  }

  /* =========================
     ✅ FIXED: agreement stays centered, checkbox next to text, normal size
     ========================= */
  .agree-row{
    margin: 12px 0 0;
    display:flex;
    justify-content:center;
  }
  .agree-line{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    width:fit-content;
    max-width: 100%;
    margin:0 auto;
    cursor:pointer;
  }
  .agree-line input[type="checkbox"]{
    width:16px;
    height:16px;
    margin:0;
    flex: 0 0 auto;
  }
  .agree-text{
    font-size:13px;
    font-weight:600;
    line-height:1.35;
    opacity:.95;
    white-space:normal;
    text-align:center;
  }
  .agree-row a{
    color:#bfffd2;
    font-weight:800;
    text-decoration:none;
  }
  .agree-row a:hover{ text-decoration: underline; }

  /* modal */
  .agreement-modal{
    position:fixed;
    inset:0;
    background: rgba(0,0,0,.62);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
    padding: 18px 14px;
    box-sizing:border-box;
  }
  .agreement-box{
    width:min(720px, 100%);
    max-height: min(86vh, 760px);
    background: rgba(25,25,25,.92);
    border:1px solid rgba(255,255,255,.14);
    border-radius: 18px;
    box-shadow: 0 24px 60px rgba(0,0,0,.55);
    overflow:hidden;
    backdrop-filter: blur(10px);
  }
  .agreement-head{
    padding: 14px 16px;
    border-bottom:1px solid rgba(255,255,255,.10);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .agreement-title{
    font-weight: 950;
    letter-spacing:.2px;
  }
  .agreement-close{
    border:0;
    background: transparent;
    color:#fff;
    font-size: 20px;
    cursor:pointer;
    opacity:.9;
  }
  .agreement-body{
    padding: 14px 16px;
    overflow:auto;
    max-height: 58vh;
    line-height: 1.55;
    font-size: 13px;
    color: rgba(255,255,255,.92);
  }
  .agreement-body h3{
    margin: 12px 0 6px;
    font-size: 13px;
    letter-spacing:.2px;
  }
  .agreement-body p{ margin: 8px 0; opacity:.95; }
  .agreement-body ul{ margin: 8px 0 8px 18px; }
  .agreement-foot{
    padding: 12px 16px;
    border-top:1px solid rgba(255,255,255,.10);
    display:flex;
    gap:10px;
    justify-content:flex-end;
  }
  .btn-agree{
    height:40px;
    padding:0 16px;
    border-radius:999px;
    border:0;
    font-weight: 900;
    cursor:pointer;
    background: linear-gradient(90deg, #0f7a3a, #22c55e);
    color:#fff;
    opacity:.55;
  }
  .btn-agree.enabled{ opacity:1; }
  .btn-decline{
    height:40px;
    padding:0 16px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.22);
    background: rgba(255,255,255,.08);
    color:#fff;
    font-weight: 900;
    cursor:pointer;
  }
</style>

<div class="auth-card card">
  <h2 class="auth-title">Create Account</h2>
  <p class="auth-sub">Open your account in minutes</p>

  {% if messages %}
    {% for message in messages %}
      {% if message.tags == "success" %}
        <div class="ok"><strong>Success:</strong> {{ message }}</div>
      {% else %}
        <div class="err"><strong>Notice:</strong> {{ message }}</div>
      {% endif %}
    {% endfor %}
  {% endif %}

  <form method="post" action="">
    {% csrf_token %}

    <input type="hidden" name="agree_accepted" id="agreeAccepted" value="0">

    <div class="field">
      <label class="label" for="id_phone">Phone Number</label>
      <div class="input-wrap">
        <svg class="icon-left" viewBox="0 0 24 24" fill="none">
          <path d="M7 3.8c.6-1 2-1.1 2.8-.3l2 2c.7.7.7 1.9 0 2.6l-1.1 1.1c-.2.2-.3.6-.2.9 1 2.3 2.8 4.1 5.1 5.1.3.1.7 0 .9-.2l1.1-1.1c.7-.7 1.9-.7 2.6 0l2 2c.8.8.7 2.2-.3 2.8l-1.2.8c-1 .7-2.2 1-3.4.7-6.2-1.5-11-6.3-12.5-12.5-.3-1.2 0-2.4.7-3.4L7 3.8Z" fill="#0f7a3a"/>
        </svg>
        <input class="input" id="id_phone" name="phone" type="tel" placeholder="Phone number" required>
      </div>
    </div>

    <div class="field">
      <label class="label" for="id_password">Password</label>
      <div class="input-wrap">
        <svg class="icon-left" viewBox="0 0 24 24" fill="none">
          <path d="M7.5 10V8.2C7.5 5.9 9.4 4 11.7 4h.6c2.3 0 4.2 1.9 4.2 4.2V10" stroke="#0f7a3a" stroke-width="2" stroke-linecap="round"/>
          <rect x="6" y="10" width="12" height="10" rx="2.4" fill="#0f7a3a" opacity=".12"/>
          <rect x="6" y="10" width="12" height="10" rx="2.4" stroke="#0f7a3a" stroke-width="2"/>
        </svg>

        <input class="input" id="id_password" name="password" type="password" placeholder="Password" required>

        <button class="eye-btn" type="button" data-target="id_password" aria-label="Toggle password">
          <svg class="eye-on" viewBox="0 0 24 24" fill="none">
            <path d="M2.3 12s3.4-6.5 9.7-6.5S21.7 12 21.7 12 18.3 18.5 12 18.5 2.3 12 2.3 12Z" stroke="#0f7a3a" stroke-width="2"/>
            <circle cx="12" cy="12" r="3" stroke="#0f7a3a" stroke-width="2"/>
          </svg>
          <svg class="eye-off" viewBox="0 0 24 24" fill="none" style="display:none">
            <path d="M3 3l18 18" stroke="#0f7a3a" stroke-width="2" stroke-linecap="round"/>
            <path d="M2.3 12s3.4-6.5 9.7-6.5c1.7 0 3.2.4 4.5 1" stroke="#0f7a3a" stroke-width="2" stroke-linecap="round"/>
            <path d="M21.7 12s-3.4 6.5-9.7 6.5c-1.7 0-3.2-.4-4.5-1" stroke="#0f7a3a" stroke-width="2" stroke-linecap="round"/>
            <path d="M10 10a3 3 0 0 1 4 4" stroke="#0f7a3a" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="field">
      <label class="label" for="id_confirm">Confirm Password</label>
      <div class="input-wrap">
        <svg class="icon-left" viewBox="0 0 24 24" fill="none">
          <path d="M7.5 10V8.2C7.5 5.9 9.4 4 11.7 4h.6c2.3 0 4.2 1.9 4.2 4.2V10" stroke="#0f7a3a" stroke-width="2" stroke-linecap="round"/>
          <rect x="6" y="10" width="12" height="10" rx="2.4" fill="#0f7a3a" opacity=".12"/>
          <rect x="6" y="10" width="12" height="10" rx="2.4" stroke="#0f7a3a" stroke-width="2"/>
        </svg>

        <input class="input" id="id_confirm" name="confirm_password" type="password" placeholder="Confirm password" required>

        <button class="eye-btn" type="button" data-target="id_confirm" aria-label="Toggle confirm password">
          <svg class="eye-on" viewBox="0 0 24 24" fill="none">
            <path d="M2.3 12s3.4-6.5 9.7-6.5S21.7 12 21.7 12 18.3 18.5 12 18.5 2.3 12 2.3 12Z" stroke="#0f7a3a" stroke-width="2"/>
            <circle cx="12" cy="12" r="3" stroke="#0f7a3a" stroke-width="2"/>
          </svg>
          <svg class="eye-off" viewBox="0 0 24 24" fill="none" style="display:none">
            <path d="M3 3l18 18" stroke="#0f7a3a" stroke-width="2" stroke-linecap="round"/>
            <path d="M2.3 12s3.4-6.5 9.7-6.5c1.7 0 3.2.4 4.5 1" stroke="#0f7a3a" stroke-width="2" stroke-linecap="round"/>
            <path d="M21.7 12s-3.4 6.5-9.7 6.5c-1.7 0-3.2-.4-4.5-1" stroke="#0f7a3a" stroke-width="2" stroke-linecap="round"/>
            <path d="M10 10a3 3 0 0 1 4 4" stroke="#0f7a3a" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- ✅ FIXED: centered, checkbox close to text, normal size -->
    <div class="agree-row">
      <div class="agree-line">
        <input type="checkbox" id="agreeChk" name="agree" value="1">
        <span class="agree-text">
          I have read and agree to the <a href="#" id="openAgreement">User Agreement</a>.
        </span>
      </div>
    </div>

    <button class="btn-main" type="submit" id="registerBtn">REGISTER</button>

    <div class="footer">
      Already have account? <a href="/login/">Back to login</a>
    </div>
  </form>
</div>

<!-- ✅ ADDED: Agreement Modal (scroll + Agree / Not Agree) -->
<div class="agreement-modal" id="agreementModal" aria-hidden="true">
  <div class="agreement-box" role="dialog" aria-modal="true" aria-label="User Agreement">
    <div class="agreement-head">
      <div class="agreement-title">User Agreement & Terms</div>
      <button class="agreement-close" type="button" id="closeAgreement" aria-label="Close">×</button>
    </div>

    <div class="agreement-body" id="agreementBody">
      <p><b>User Agreement & Terms of Service</b></p>
      <p><b>Last Updated:</b> {{ now|default:"" }}</p>

      <p>
        Welcome to <b>GreenBank.com</b> (“Platform”, “we”, “our”, “us”). This agreement is a legal contract between you (“User”,
        “you”, “your”) and the Platform. By creating an account, accessing, browsing, or using any part of the Platform,
        you confirm that you understand and accept the terms below.
      </p>

      <h3>1) Definitions</h3>
      <p>
        “Account” means your registered profile tied to a unique phone number. “Application” means any request submitted
        through the Platform, including verification submissions, service requests, support requests, or loan-related
        processes. “Content” means text, data, images, documents, and files uploaded by you.
      </p>

      <h3>2) Eligibility & User Promises</h3>
      <ul>
        <li>You confirm you are legally allowed to use this Platform.</li>
        <li>You confirm you provide true, complete, and accurate information.</li>
        <li>You confirm you will not use the Platform for illegal, harmful, or fraudulent activity.</li>
        <li>You confirm you understand that approval of any application is not guaranteed.</li>
      </ul>

      <h3>3) One Account Per Phone Number</h3>
      <p>
        Each phone number may only create <b>one</b> account. If a phone number is already registered, you must use the login
        page. Creating multiple accounts, attempting to reuse phone numbers, or using another person’s phone number without
        permission is strictly prohibited.
      </p>

      <h3>4) Account Security</h3>
      <ul>
        <li>You are responsible for keeping your password confidential.</li>
        <li>You must not share your password or verification codes with anyone.</li>
        <li>If you suspect unauthorized access, you must notify support immediately.</li>
        <li>Actions taken under your account are treated as authorized by you.</li>
      </ul>

      <h3>5) Acceptable Use</h3>
      <p>You agree that you will not:</p>
      <ul>
        <li>Submit false, edited, or misleading documents.</li>
        <li>Impersonate any person or entity.</li>
        <li>Attempt to hack, exploit, disrupt, or bypass Platform security.</li>
        <li>Use automation or scripts to abuse registration, submissions, or messaging.</li>
        <li>Harass or threaten staff or other users.</li>
        <li>Upload malware, harmful files, or suspicious links.</li>
      </ul>

      <p style="margin-top:18px; opacity:.70;">End of Agreement.</p>
    </div>

    <div class="agreement-foot">
      <button class="btn-decline" type="button" id="declineAgreement">Not Agree</button>
      <button class="btn-agree" type="button" id="acceptAgreement" disabled>Agree</button>
    </div>
  </div>
</div>

<script>
  document.querySelectorAll('.eye-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-target');
      const input = document.getElementById(id);
      if (!input) return;

      const on = btn.querySelector('.eye-on');
      const off = btn.querySelector('.eye-off');

      const isHidden = input.type === 'password';
      input.type = isHidden ? 'text' : 'password';

      if (on && off){
        on.style.display = isHidden ? 'none' : 'block';
        off.style.display = isHidden ? 'block' : 'none';
      }
    });
  });

  (function(){
    const modal = document.getElementById('agreementModal');
    const openBtn = document.getElementById('openAgreement');
    const closeBtn = document.getElementById('closeAgreement');
    const declineBtn = document.getElementById('declineAgreement');
    const acceptBtn = document.getElementById('acceptAgreement');
    const body = document.getElementById('agreementBody');

    const agreeChk = document.getElementById('agreeChk');
    const registerBtn = document.getElementById('registerBtn');

    // ✅ ADDED: hidden input (this is what your backend reads)
    const agreeHidden = document.getElementById('agreeAccepted');

    let hasAccepted = false;

    // ✅ UPDATED: now it also updates hidden input value 0/1
    function syncRegisterButton(){
      agreeChk.checked = hasAccepted;
      if (agreeHidden) {
      agreeHidden.value = hasAccepted ? "1" : "0";
    }
  }

    function openModal(e){
      if (e) e.preventDefault();
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');

      acceptBtn.disabled = true;
      acceptBtn.classList.remove('enabled');
      body.scrollTop = 0;
    }

    function closeModal(){
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    }

    // click link -> open modal only
    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);

    // enable Agree only when scrolled to bottom
    body.addEventListener('scroll', () => {
      const nearBottom = body.scrollTop + body.clientHeight >= body.scrollHeight - 6;
      if (nearBottom){
        acceptBtn.disabled = false;
        acceptBtn.classList.add('enabled');
      }
    });

    declineBtn.addEventListener('click', () => {
      hasAccepted = false;
      agreeHidden.value = "0";
      syncRegisterButton();
      closeModal();
    });

    acceptBtn.addEventListener('click', () => {
      hasAccepted = true;
      agreeHidden.value = "1";
      syncRegisterButton();
  closeModal();
    });

    // if user clicks checkbox, force modal (must accept inside modal)
    agreeChk.addEventListener('change', () => {
      if (!hasAccepted){
        agreeChk.checked = false;
        openModal();
      }
    });

    syncRegisterButton();

    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });
  })();
</script>
{% endblock %}
